# Contextå­—æ®µç§»é™¤å®ŒæˆæŠ¥å‘Š

## ğŸ¯ ç›®æ ‡
ç§»é™¤PDFè§£æå’Œembeddingè¿‡ç¨‹ä¸­çš„contextå­—æ®µï¼Œå› ä¸ºç°åœ¨å›¾ç‰‡ä¼šä½¿ç”¨VLMè¿›è¡Œæ›´å‡†ç¡®çš„æè¿°ï¼Œcontextå­—æ®µå·²ä¸å†éœ€è¦ã€‚

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

### ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

#### 1. **Paper2Poster/Paper2Poster/parser_agent_openrouter.py**
- **ç§»é™¤**: æå–å‰å2ä¸ªTextItemæ–‡æœ¬çš„contextç”Ÿæˆé€»è¾‘
- **ç§»é™¤**: imageså­—å…¸ä¸­çš„'context'å­—æ®µ
- **å½±å“**: æ–°ç”Ÿæˆçš„images.jsonæ–‡ä»¶å°†ä¸å†åŒ…å«contextå­—æ®µ

#### 2. **src/pdf_parser_tool.py**
- **ç§»é™¤**: æå–å‰åæ–‡æœ¬ä¸Šä¸‹æ–‡çš„contextç”Ÿæˆé€»è¾‘  
- **ç§»é™¤**: imageså­—å…¸ä¸­çš„'context'å­—æ®µ
- **å½±å“**: PDFè§£æå·¥å…·ç”Ÿæˆçš„images.jsonæ–‡ä»¶å°†ä¸å†åŒ…å«contextå­—æ®µ

#### 3. **src/pdf_embedding_service.py**
- **ç§»é™¤**: è¯»å–images.jsonæ—¶å¯¹contextå­—æ®µçš„è·å–
- **ç§»é™¤**: `_generate_image_description`æ–¹æ³•çš„contextå‚æ•°
- **ç§»é™¤**: VLMæç¤ºè¯ä¸­çš„contextä¿¡æ¯æ·»åŠ 
- **ç§»é™¤**: å›¾ç‰‡æè¿°ä¸­çš„contextå†…å®¹ç»„åˆ
- **ç§»é™¤**: å…ƒæ•°æ®ä¸­çš„contextå­—æ®µå­˜å‚¨
- **ç§»é™¤**: åŸºæœ¬æè¿°ä¸­çš„contextä¿¡æ¯æ·»åŠ 

### ğŸš€ æ ¸å¿ƒæ”¹è¿›

#### åŸæœ‰å®ç°ï¼ˆå¸¦contextï¼‰
```python
# 1. è§£ææ—¶ç”Ÿæˆcontext
context_texts = []
# å‘å‰æ‰¾2ä¸ªTextItem
prev = idx - 1
found = 0
while prev >= 0 and found < 2:
    prev_elem, _ = all_elements[prev]
    if hasattr(prev_elem, 'text') and prev_elem.text:
        context_texts.insert(0, prev_elem.text.strip())
        found += 1
    prev -= 1
context = '\n'.join([t for t in context_texts if t])

# 2. å­˜å‚¨context
images[str(picture_counter)] = {
    'caption': caption,
    'context': context,
    # ... å…¶ä»–å­—æ®µ
}

# 3. embeddingæ—¶ä½¿ç”¨context
context = image_info.get("context", "")
image_description = self._generate_image_description(
    full_image_path, caption, context, image_id
)
```

#### æ–°å®ç°ï¼ˆæ— contextï¼‰
```python
# 1. è§£ææ—¶ä¸ç”Ÿæˆcontext
# [å·²ç§»é™¤] ä¸å†æå–contextå­—æ®µï¼Œä½¿ç”¨VLMè¿›è¡Œå›¾ç‰‡æè¿°

# 2. å­˜å‚¨æ—¶ä¸åŒ…å«context
images[str(picture_counter)] = {
    'caption': caption,
    # [å·²ç§»é™¤] 'context': context, - ä¸å†ä½¿ç”¨contextå­—æ®µï¼Œç”±VLMç”Ÿæˆæè¿°
    # ... å…¶ä»–å­—æ®µ
}

# 3. embeddingæ—¶ä¸ä½¿ç”¨context
# [å·²ç§»é™¤] context = image_info.get("context", "") - ä¸å†ä½¿ç”¨contextå­—æ®µ
image_description = self._generate_image_description(
    full_image_path, caption, image_id
)
```

### ğŸ› ï¸ æŠ€æœ¯ä¼˜åŠ¿

#### ğŸ“ˆ æ€§èƒ½æå‡
- **å‡å°‘è§£ææ—¶é—´**: ä¸å†éœ€è¦éå†å‰åæ–‡æœ¬å…ƒç´ 
- **å‡å°‘å­˜å‚¨ç©ºé—´**: images.jsonæ–‡ä»¶ä½“ç§¯å‡å°
- **å‡å°‘å†…å­˜ä½¿ç”¨**: ä¸å†å­˜å‚¨å’Œä¼ é€’contextæ•°æ®

#### ğŸ§  è´¨é‡æå‡
- **æ›´å‡†ç¡®æè¿°**: å®Œå…¨ä¾èµ–VLMå¯¹å›¾ç‰‡å†…å®¹çš„ç›´æ¥åˆ†æ
- **æ¶ˆé™¤å¹²æ‰°**: é¿å…æ— å…³æ–‡æœ¬contextå½±å“å›¾ç‰‡ç†è§£
- **è¯­ä¹‰ä¸€è‡´**: VLMç”Ÿæˆçš„æè¿°ä¸å›¾ç‰‡å†…å®¹é«˜åº¦ä¸€è‡´

#### ğŸ”„ æ¶æ„ç®€åŒ–
- **å‡å°‘ä¾èµ–**: ä¸å†ä¾èµ–PDFæ–‡æœ¬ç»“æ„æ¥ç†è§£å›¾ç‰‡
- **æé«˜é²æ£’æ€§**: ä¸å—PDFè§£æè´¨é‡å½±å“
- **ä»£ç ç®€åŒ–**: å‡å°‘contextç›¸å…³çš„å¤„ç†é€»è¾‘

### ğŸ“Š å½±å“åˆ†æ

#### âœ… æ­£é¢å½±å“
1. **æœç´¢ç²¾åº¦æå‡**: VLMæè¿°æ¯”contextæ›´å‡†ç¡®
2. **ç³»ç»Ÿæ€§èƒ½æå‡**: å‡å°‘ä¸å¿…è¦çš„æ•°æ®å¤„ç†
3. **ç»´æŠ¤æˆæœ¬é™ä½**: å‡å°‘ä»£ç å¤æ‚åº¦

#### âš ï¸ éœ€è¦æ³¨æ„
1. **å†å²æ•°æ®**: å·²å­˜åœ¨çš„images.jsonæ–‡ä»¶å¯èƒ½ä»åŒ…å«contextå­—æ®µ
2. **å…¼å®¹æ€§**: ç³»ç»Ÿéœ€è¦èƒ½å¤Ÿå¤„ç†å¸¦å’Œä¸å¸¦contextå­—æ®µçš„æ•°æ®
3. **VLMä¾èµ–**: å›¾ç‰‡æè¿°è´¨é‡å®Œå…¨ä¾èµ–VLMæœåŠ¡

### ğŸ”„ å‘åå…¼å®¹æ€§

å½“å‰çš„å®ç°å·²ç»è€ƒè™‘äº†å‘åå…¼å®¹æ€§ï¼š
- è¯»å–images.jsonæ—¶ä½¿ç”¨`.get("context", "")`ï¼Œä¸ä¼šå› ä¸ºç¼ºå°‘contextå­—æ®µè€Œå‡ºé”™
- VLMæè¿°ç”Ÿæˆå¤±è´¥æ—¶ä¼šå›é€€åˆ°åŸºæœ¬æè¿°ï¼ˆä»…ä½¿ç”¨captionï¼‰
- å…ƒæ•°æ®ä¸­ä¸å†å­˜å‚¨contextå­—æ®µï¼Œä½†ä¸å½±å“ç°æœ‰æœç´¢åŠŸèƒ½

### ğŸ“ ä½¿ç”¨å»ºè®®

1. **æ–°é¡¹ç›®**: ç›´æ¥ä½¿ç”¨ä¿®æ”¹åçš„ä»£ç ï¼Œäº«å—æ€§èƒ½å’Œè´¨é‡æå‡
2. **ç°æœ‰é¡¹ç›®**: å¯ä»¥å¹³æ»‘å‡çº§ï¼Œè€æ•°æ®ä»å¯æ­£å¸¸ä½¿ç”¨
3. **VLMé…ç½®**: ç¡®ä¿VLMæœåŠ¡æ­£å¸¸è¿è¡Œï¼Œä»¥è·å¾—æœ€ä½³å›¾ç‰‡æè¿°è´¨é‡

## ğŸ¯ æ€»ç»“

æœ¬æ¬¡ä¿®æ”¹æˆåŠŸç§»é™¤äº†PDFè§£æå’Œembeddingè¿‡ç¨‹ä¸­ä¸å¿…è¦çš„contextå­—æ®µï¼Œå®ç°äº†ï¼š
- **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘è§£ææ—¶é—´å’Œå­˜å‚¨ç©ºé—´
- **è´¨é‡æå‡**: ä¾èµ–VLMç”Ÿæˆæ›´å‡†ç¡®çš„å›¾ç‰‡æè¿°
- **æ¶æ„ç®€åŒ–**: å‡å°‘ä»£ç å¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬
- **å‘åå…¼å®¹**: ä¿è¯ç°æœ‰æ•°æ®å’ŒåŠŸèƒ½ä¸å—å½±å“

ä¿®æ”¹åçš„ç³»ç»Ÿæ›´åŠ é«˜æ•ˆã€å‡†ç¡®ï¼Œå¹¶ä¸”å®Œå…¨ä¾èµ–VLMçš„å¼ºå¤§å›¾ç‰‡ç†è§£èƒ½åŠ›æ¥ç”Ÿæˆé«˜è´¨é‡çš„å›¾ç‰‡æè¿°ã€‚ 